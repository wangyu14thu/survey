# 部署指南

本文档详细说明如何部署社会实践投票小程序。

## 部署前准备

### 1. 账号准备

- [ ] 微信小程序账号（已认证）
- [ ] 小程序AppID
- [ ] 云开发环境已开通

### 2. 开发工具

- [ ] 微信开发者工具（最新稳定版）
- [ ] Node.js 环境（v12.0+）

## 部署步骤

### 第一步：克隆项目

```bash
# 克隆或下载项目到本地
cd /path/to/your/workspace
```

### 第二步：配置项目

#### 2.1 修改AppID

编辑 `project.config.json`：

```json
{
  "appid": "wxYOUR_APPID_HERE"
}
```

#### 2.2 配置云开发环境

编辑 `app.js`：

```javascript
wx.cloud.init({
  env: 'your-cloud-env-id',  // 替换为你的云环境ID
  traceUser: true
});
```

### 第三步：准备云开发环境

#### 3.1 创建云环境

1. 打开[微信小程序后台](https://mp.weixin.qq.com/)
2. 进入"开发" -> "云开发"
3. 创建新环境（推荐创建两个：开发环境和生产环境）
4. 记录环境ID

#### 3.2 创建数据库集合

在云开发控制台的数据库页面，创建以下集合：

| 集合名称 | 说明 | 权限建议 |
|---------|------|---------|
| authorizations | 监护人授权记录 | 仅创建者可读写 |
| users | 用户信息 | 仅创建者可读写 |
| votes | 投票记录 | 仅创建者写，所有人读 |
| vote_stats | 投票统计 | 所有人可读，管理员可写 |
| vote_config | 投票配置 | 所有人可读，管理员可写 |
| albums | 相册 | 按classId控制 |
| certificates | 证书 | 仅创建者可读写 |
| courses | 课程 | 所有人可读，管理员可写 |
| orders | 订单 | 仅创建者可读写 |
| classes | 班级信息 | 所有人可读，管理员可写 |

#### 3.3 初始化数据

**vote_stats 集合**：

在云开发控制台，点击"添加记录"，依次添加：

```json
{"themeId": 1, "themeName": "绿色地球", "votes": 0}
{"themeId": 2, "themeName": "动植物保护", "votes": 0}
{"themeId": 3, "themeName": "科学发明", "votes": 0}
{"themeId": 4, "themeName": "传统文化", "votes": 0}
{"themeId": 5, "themeName": "文化创意", "votes": 0}
{"themeId": 6, "themeName": "野外生存", "votes": 0}
```

**courses 集合**：

```json
{"id": 1, "title": "开演啦！中国古典四大名著", "enrolled": 0, "quota": 48}
{"id": 2, "title": "小小发明家", "enrolled": 0, "quota": 30}
```

**classes 集合**（示例，根据实际情况添加）：

```json
{
  "classCode": "CLASS001",
  "school": "北京示例小学",
  "grade": "三年级",
  "name": "1班"
}
```

**vote_config 集合**：

```json
{
  "_id": "main",
  "ended": false,
  "published": false,
  "startTime": "2026-01-14T00:00:00.000Z",
  "endTime": "2026-01-21T00:00:00.000Z"
}
```

### 第四步：准备图片资源

在 `images/` 目录下准备所有图片：

```bash
images/
├── home.png (64x64)
├── home-active.png (64x64)
├── album.png (64x64)
├── album-active.png (64x64)
├── course.png (64x64)
├── course-active.png (64x64)
├── profile.png (64x64)
├── profile-active.png (64x64)
├── banner-course.jpg (750x360)
├── banner-vote.jpg (750x360)
├── auth-shield.png (320x320)
├── register-bg.png (750x800)
├── cert-bg.png (1000x1414)
├── cert-detail-bg.png (1000x1414)
├── empty-album.png (800x800)
├── empty-certificate.png (800x800)
├── empty-course.png (800x800)
├── empty-order.png (800x800)
├── themes/
│   ├── green-earth.jpg (750x600)
│   ├── wildlife.jpg (750x600)
│   ├── science.jpg (750x600)
│   ├── culture.jpg (750x600)
│   ├── creative.jpg (750x600)
│   └── survival.jpg (750x600)
└── courses/
    ├── famous-books.jpg (750x600)
    ├── inventor.jpg (750x600)
    ├── detail1.jpg (750x500)
    ├── detail2.jpg (750x500)
    └── detail3.jpg (750x500)
```

**图片获取建议**：
- 使用无版权图片网站（如Unsplash、Pexels）
- 使用AI生成图片（如Midjourney、DALL·E）
- 自行拍摄或设计

### 第五步：上传云函数

在微信开发者工具中：

1. 展开 `cloudfunctions` 目录
2. 右键每个云函数文件夹
3. 选择"上传并部署：云端安装依赖"
4. 等待上传完成

需要上传的云函数：
- ✅ login
- ✅ authorization
- ✅ user
- ✅ vote
- ✅ album
- ✅ certificate
- ✅ course
- ✅ order
- ✅ admin

### 第六步：配置云存储

1. 在云开发控制台进入"存储"页面
2. 创建以下目录结构：
   ```
   albums/
   certificates/
   ```

### 第七步：测试

#### 7.1 本地测试

1. 在微信开发者工具中点击"编译"
2. 测试各个功能模块：
   - [ ] 授权流程
   - [ ] 用户注册
   - [ ] 投票功能
   - [ ] 相册功能
   - [ ] 证书功能
   - [ ] 课程浏览
   - [ ] 订单管理

#### 7.2 真机测试

1. 点击"预览"生成二维码
2. 用手机微信扫码
3. 在真机上测试所有功能

### 第八步：提交审核

#### 8.1 准备审核材料

- [ ] 小程序简介
- [ ] 小程序类目（教育 > 在线教育）
- [ ] 服务类目资质（如需要）
- [ ] 测试账号和密码
- [ ] 隐私协议链接

#### 8.2 配置小程序信息

在[小程序后台](https://mp.weixin.qq.com/)：

1. **基本设置**
   - 设置小程序名称
   - 上传小程序头像
   - 填写简介

2. **开发设置**
   - 配置服务器域名（如有额外接口）
   - 配置业务域名（如有H5页面）

3. **版本管理**
   - 在微信开发者工具点击"上传"
   - 填写版本号和项目备注
   - 在后台提交审核

### 第九步：发布上线

1. 等待审核通过（通常1-7个工作日）
2. 审核通过后，在后台点击"发布"
3. 发布成功后，用户即可搜索到小程序

## 配置检查清单

### 必须配置项

- [ ] AppID已修改
- [ ] 云环境ID已配置
- [ ] 所有数据库集合已创建
- [ ] 初始数据已导入
- [ ] 所有云函数已上传
- [ ] 图片资源已准备
- [ ] 本地测试通过
- [ ] 真机测试通过

### 可选配置项

- [ ] 支付功能（需要商户号）
- [ ] 消息推送（需要配置模板消息）
- [ ] 数据统计（可接入第三方统计）
- [ ] CDN加速（优化图片加载）

## 环境管理建议

### 开发环境

- 环境名称：dev
- 用途：日常开发和测试
- 数据：测试数据

### 生产环境

- 环境名称：prod
- 用途：正式上线使用
- 数据：真实用户数据

### 切换环境

修改 `app.js` 中的环境ID：

```javascript
// 开发环境
wx.cloud.init({ env: 'dev-xxxxx' })

// 生产环境
wx.cloud.init({ env: 'prod-xxxxx' })
```

## 数据备份

### 定期备份

1. 在云开发控制台进入"数据库"
2. 选择集合，点击"导出"
3. 下载JSON文件保存

### 恢复数据

1. 点击"导入"
2. 选择之前导出的JSON文件
3. 确认导入

## 监控和维护

### 云函数日志

在云开发控制台"云函数"页面查看调用日志和错误信息。

### 数据库监控

在"数据库"页面查看：
- 存储容量
- 读写次数
- 索引使用情况

### 用户反馈

建议在小程序中添加反馈入口，及时收集用户问题。

## 常见部署问题

### Q1: 云函数上传失败

**解决方案**：
1. 检查网络连接
2. 确认云开发环境已开通
3. 尝试手动安装依赖后再上传

### Q2: 图片显示不出来

**解决方案**：
1. 检查图片路径是否正确
2. 确认图片文件已存在
3. 检查图片格式是否支持

### Q3: 数据库读写失败

**解决方案**：
1. 检查权限设置
2. 确认环境ID配置正确
3. 查看云函数日志

### Q4: 支付功能无法使用

**解决方案**：
1. 确认已开通微信支付
2. 配置支付密钥
3. 实现支付回调云函数

## 性能优化建议

1. **图片优化**
   - 使用WebP格式
   - 压缩图片大小
   - 使用CDN加速

2. **代码优化**
   - 按需加载页面
   - 减少不必要的请求
   - 使用分包加载

3. **云函数优化**
   - 合并相似接口
   - 添加缓存机制
   - 优化数据库查询

## 更新维护

### 小版本更新

对于bug修复和小功能更新：

1. 修改代码
2. 本地测试
3. 上传新版本
4. 提交审核

### 大版本更新

对于重大功能更新：

1. 在测试环境充分测试
2. 准备数据迁移方案
3. 制定回滚计划
4. 发布前通知用户
5. 上线后密切监控

## 技术支持

如遇到无法解决的问题，可通过以下方式获取帮助：

1. 查看[微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
2. 在[微信开放社区](https://developers.weixin.qq.com/community/)提问
3. 联系云开发技术支持

---

**祝部署顺利！**

